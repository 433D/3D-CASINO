<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>賭け情報入力</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, select, button { margin: 10px 0; padding: 10px; width: 100%; max-width: 300px; }
        button { background-color: #007BFF; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>賭け情報入力</h1>
    <form id="betForm">
        <label for="player_id">プレイヤーID:</label>
        <input type="text" id="player_id" required>

        <label for="player_name">プレイヤー名:</label>
        <input type="text" id="player_name" readonly>

        <label for="balance">所持金:</label>
        <input type="text" id="balance" readonly>

        <label for="horse">賭け先:</label>
        <select id="horse" required>
            <option value="Aさん">Aさん</option>
            <option value="Bさん">Bさん</option>
            <option value="Cさん">Cさん</option>
            <option value="Dさん">Dさん</option>
        </select>

        <label for="amount">賭け金額:</label>
        <input type="number" id="amount" step="1000" required>

        <button type="submit">賭ける</button>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/1Tq-nGqM-PhpX_tw92zQWhM88_0fNRDp8qdjjmz63a98/gviz/tq?tqx=out:json&gid=0';
        const SUPABASE_URL = 'https://nvxdgqdxyzjpothjuwhx.supabase.co'; // SupabaseのURL
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52eGRncWR4eXpqcG90eGp1d2h4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjUwNzczNDMsImV4cCI6MjA0MDY1MzM0M30.3iyzaavXPkN0mGhfA4vJC9t1oijI3Qe-nVGMfPzjS-s';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // プレイヤー情報の取得
        document.getElementById('player_id').addEventListener('input', function() {
            const playerId = this.value;
            fetch(SPREADSHEET_URL)
                .then(response => response.text())
                .then(data => {
                    const jsonData = JSON.parse(data.substr(47).slice(0, -2));
                    const rows = jsonData.table.rows;
                    const player = rows.find(row => row.c[0].v == playerId);
                    if (player) {
                        document.getElementById('player_name').value = player.c[1].v;
                        document.getElementById('balance').value = player.c[2].v;
                    } else {
                        document.getElementById('player_name').value = '';
                        document.getElementById('balance').value = '';
                    }
                })
                .catch(error => console.error('Error fetching player data:', error));
        });

        // 賭け情報の送信
        document.getElementById('betForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const playerId = document.getElementById('player_id').value;
            const horse = document.getElementById('horse').value;
            const amount = parseInt(document.getElementById('amount').value);
            const balance = parseInt(document.getElementById('balance').value);

            // 賭け金額が所持金以内かつ1000円単位であることを確認
            if (amount > balance || amount % 1000 !== 0) {
                alert('賭け金額は所持金以内かつ1000円単位で入力してください。');
                return;
            }

            try {
                // Supabaseに賭け情報を送信
                const { data, error } = await supabase
                    .from('bets') // 使用するテーブル名を確認してください
                    .insert([{ player_id: playerId, bet_target: horse, bet_amount: amount }]);

                if (error) {
                    console.error('Error sending bet data:', error);
                    alert('賭け情報の送信中にエラーが発生しました。');
                } else {
                    alert('賭け情報がSupabaseに正常に送信されました！');
                    // フォームをリセット
                    document.getElementById('betForm').reset();
                }
            } catch (error) {
                console.error('Unexpected error:', error);
                alert('予期しないエラーが発生しました。');
            }
        });
    </script>
</body>
</html>
